# Storm Damage Analysis X

## Required Packages

To download and read the data, we need the following packages:

```{R results="hide", include=FALSE, cache=FALSE}
install.packages("downloader", repos="http://cran.us.r-project.org")
install.packages("R.utils", , repos="http://cran.us.r-project.org")

library(downloader)  # download (hopefully platform independent)
library(tools)  # md5sum
library(R.utils)  # bunzip2d
```

## Source Data

```{R}
if(!file.exists("data")){dir.create("data")}

fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"

if(!file.exists("data/repdata-data-StormData.csv")) {
  download.file(fileUrl,destfile="./data/repdata-data-StormData.csv.bz2",method="curl")
  bunzip2("data/repdata-data-StormData.csv.bz2")
}
stormDataRaw <- read.csv("data/repdata-data-StormData.csv")
```

## Data Exploration

```{R}
dim(stormDataRaw)
str(stormDataRaw)
```

## Data Cleanse

We will be using `dplyr` package for data manipulation.

```{R results="hide", include=FALSE, cache=FALSE}
# Use dplyr
install.packages("dplyr", repos="http://cran.us.r-project.org")
library(dplyr)
```

Mutate data

```{R}
# First take a subset of relevant column variables
stormData <- dplyr::select(stormDataRaw, BGN_DATE, EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP)
```

Convert date

```{R}
# Convert date
stormData$beginDate <- as.Date(strptime(stormData$BGN_DATE, format = "%m/%d/%Y %H:%M:%S"))
```

Standardize Events

```{R}
#stormData$eventType <- as.character(stormData$EVTYPE)

stormData <- mutate(stormData, eventType = as.character(stormData$EVTYPE))

stormData$eventType[grepl("tornad", stormData$eventType, ignore.case = TRUE)]          <- "TORNADO"
stormData$eventType[grepl("thun.*orm", stormData$eventType, ignore.case = TRUE)]       <- "THUNDERSTORM"  
stormData$eventType[grepl("tstm", stormData$eventType, ignore.case = TRUE)]            <- "THUNDERSTORM"  
stormData$eventType[grepl("snow", stormData$eventType, ignore.case = TRUE)]            <- "SNOW"  
stormData$eventType[grepl("blizzard", stormData$eventType, ignore.case = TRUE)]        <- "BLIZZARD"  
stormData$eventType[grepl("hail", stormData$eventType, ignore.case = TRUE)]            <- "HAIL"  
stormData$eventType[grepl("rain", stormData$eventType, ignore.case = TRUE)]            <- "RAIN"  
stormData$eventType[grepl("precip", stormData$eventType, ignore.case = TRUE)]          <- "RAIN"  
stormData$eventType[grepl("hurricane", stormData$eventType, ignore.case = TRUE)]       <- "HURRICANE"  
stormData$eventType[grepl("tropical.*storm", stormData$eventType, ignore.case = TRUE)] <- "TROPICALSTORM"  
stormData$eventType[grepl("flood", stormData$eventType, ignore.case = TRUE)]           <- "FLOOD"  
stormData$eventType[grepl("fire", stormData$eventType, ignore.case = TRUE)]            <- "FIRE"  
stormData$eventType[grepl("lightn", stormData$eventType, ignore.case = TRUE)]          <- "LIGHTNING"  
stormData$eventType[grepl("wind", stormData$eventType, ignore.case = TRUE)]            <- "WIND"  
stormData$eventType[grepl("cold", stormData$eventType, ignore.case = TRUE)]            <- "COLD"  
stormData$eventType[grepl("heat", stormData$eventType, ignore.case = TRUE)]            <- "HEAT"  
stormData$eventType[grepl("storm surge", stormData$eventType, ignore.case = TRUE)]     <- "STORM SURGE"
stormData$eventType[grepl("freeze", stormData$eventType, ignore.case = TRUE)]          <- "FREEZE"
stormData$eventType[grepl("frost", stormData$eventType, ignore.case = TRUE)]          <- "FREEZE"
stormData$eventType <- as.factor(stormData$eventType)
```

Aggregate event damage

```{R}
# Calculate property damage amounts
PROPDMGEXP  <- levels(stormData$PROPDMGEXP)
pMultiplier <- c(1,1,1,1,1,10,100,1000,10000,100000,1000000,10000000,100000000,1000000000,100,100,1000,1000000,1000000)
propLookup  <- data.frame(cbind(PROPDMGEXP,pMultiplier))
propLookup$pMultiplier <- as.numeric(as.character(propLookup$pMultiplier))
stormData <- merge(stormData,propLookup)
stormData$totalPropDamage <- stormData$PROPDMG*stormData$pMultiplier
# Compute crop damage
CROPDMGEXP <- levels(stormData$CROPDMGEXP)
cMultiplier <- c(1,1,1,100,1000000000,1000,1000,1000000,1000000)        # crop damage multipliers  
cropLookup  <- data.frame(cbind(CROPDMGEXP, cMultiplier))                # cropLookup table  
cropLookup$cMultiplier <- as.numeric(as.character(cropLookup$cMultiplier))
stormData <- merge(stormData,cropLookup)
stormData$totalCropDamage <- stormData$CROPDMG*stormData$cMultiplier
stormData$totalDamage <- stormData$totalPropDamage + stormData$totalCropDamage

topEconDamage <- stormData %>% group_by(eventType) %>% summarise(sumTotalDamage=sum(totalDamage)) %>% arrange(desc(sumTotalDamage))

# Compute human damage
topHumanFatalities <- stormData %>% group_by(eventType) %>% summarise(sumHumanFatalities=sum(FATALITIES)) %>% arrange(desc(sumHumanFatalities))
topHumanInjuries <- stormData %>% group_by(eventType) %>% summarise(sumHumanInjuries=sum(INJURIES)) %>% arrange(desc(sumHumanInjuries))

# Combine all top damage data sets
allDamage <- merge(topEconDamage, topHumanFatalities)
allDamage <- merge(allDamage, topHumanInjuries)
allDamage$sumHumanImpact <- allDamage$sumHumanFatalities + allDamage$sumHumanInjuries

topDamage <- arrange(allDamage,desc(sumTotalDamage))[1:12,]
topDamage

topHumanDamage <- arrange(allDamage,desc(sumHumanImpact))[1:12,]
topHumanDamage
```

Plotting libraries

```{R results="hide", include=FALSE, cache=FALSE}
install.packages("ggplot2", repos="http://cran.us.r-project.org")
library(ggplot2)
```

Show total damage as 2d scatter plot with total economic damage as x total human impact as y

```{R}
ggplot(topDamage, aes(x=sumTotalDamage, y=sumHumanImpact, color=eventType)) +  
    geom_point(aes(size = sumHumanFatalities), alpha=.5) +
    labs(size="Fatalities") +
    geom_text(data = topDamage[topDamage$eventType=="TORNADO" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), hjust = 1.1, vjust = 1.1) +
    geom_text(data = topDamage[topDamage$eventType=="FLOOD" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), hjust = 1, vjust = -1) +
    geom_text(data = topDamage[topDamage$eventType=="HAIL" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), hjust = -.8, vjust = -.8) +
    geom_text(data = topDamage[topDamage$eventType=="HEAT" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), hjust = 1, vjust = -1) +
    geom_text(data = topDamage[topDamage$eventType=="HURRICANE" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), hjust = -1, vjust = .5) +
    geom_text(data = topDamage[topDamage$eventType=="LIGHTNING" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), vjust = -.3) +
    geom_text(data = topDamage[topDamage$eventType=="RIP CURRENT" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), hjust = .5, vjust = -.3) +
    geom_text(data = topDamage[topDamage$eventType=="THUNDERSTORM" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), hjust = .5, vjust = -1) +
    geom_text(data = topDamage[topDamage$eventType=="WIND" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), hjust = .5, vjust = -1) +
    geom_text(data = topDamage[topDamage$eventType=="FIRE" ,], 
              aes(sumTotalDamage,sumHumanImpact, label = eventType), hjust = -.3, vjust = .5) +
    scale_colour_brewer(palette="Paired")   +
    scale_size_area(max_size=30) +
    scale_x_continuous(labels = scales::dollar)  +
    scale_y_continuous(labels = scales::comma) +
    xlab("Economic Impact") +
    ylab("Human Impact") +
    ggtitle("Most Impactful Human and\nEconomic Damage from Storms")
```